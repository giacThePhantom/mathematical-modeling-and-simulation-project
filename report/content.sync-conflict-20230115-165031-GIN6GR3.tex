\begin{abstract}
\end{abstract}

\input{chapters/01_introduction}

\input{chapters/02_random-time-representation}
	\subsection{Gillespie representation}
	The Gillespie representation is an alternative representation for the stochastic process built before.
	Let:

	\begin{itemize}
		\item $Y$ be a unit rate Poisson process.
		\item $\{\epsilon_i, i = 0, 1, 2, \dots\}$ be independent, uniform $(0,1)$ random variables independent of $Y$.
	\end{itemize}

	Set:

	$$\lambda_0(V(s), X(s)) = \sum\limits_{k=1}^M\lambda_k(V(s), X(s))$$

	$$q_0 = 0$$

	And $\forall k\in\{1, \dots, M\}$:

	$$q_k(s) = \lambda_0(V(s), X(s))^{-1}\sum\limits_{l=1}^k\lambda_l(V(s), X(s))$$

	Where $X$ and $Y$ satisfy:

	$$R_0(t) = Y\biggl(\int_o^t\lambda_0(V(s), X(s))ds\biggr)$$

	$$X(t) = X(0) + \sum\limits_{k=1}^M\zeta_k\int_0^t1\{\epsilon_{r_0(s-)}\in[q_{k-1}(s-), q_k(s-)[\}dR_0(s)$$

	$$C\frac{dV}{dt} = i_{app}(t)-I_V(V(t)) - \biggl(\sum\limits_{i=1}^dg_o^oX_i(t)\biggr)(V(t)-V_X)$$

	The stochastic process $(X, V)$ descried in the equation above is a Markov process equivalent to the one described in the previous section.
	To understand it note that $R_o(t)$ determines the holding time in each state and the middle equation determines the embedded discrete time Markov chain or skeletal chain in the usual manner.
	This is the representation for the Gillespie algorithm, with time dependent propensity functions.
	This representation is analogous to the PDMP formalism with $\lambda_0$ the rate function that determines the time of the next jump and the middle equation the transitions.

		\subsubsection{Simulation of the representation}
		The simulation is analogous of using Gillespie's algorithm in the time-homogeneous case.
		The algorithm is \ref{algo:gillespie} and all number are assumed to be independent.

		\input{algorithms/gillespie}

		This algorithm also relies on being able to compute a hitting time.


\input{chapters/04_morris-lecar}
\section{Models with more than one channel type}
Now the original Morris-Lecar model is considered, where there is a three-dimensional phase space, taking both the calcium and potassium channel to be discrete.

	\subsection{Random time change representation}
	In the original treatment of voltage oscillations  in barnacle muscle fibres the calcium gating variable $m$ is included as a dynamical variable, sot the total system is describes with the following deterministic equations:


	\begin{align*}
		\frac{dv}{dt} = F(v, n, m) =&\frac{1}{C}(I_{app}-g_L(v-v_L)+\\
																&-g_{Ca}m(v-v_Ca)-g_Kn(v-v_K))
	\end{align*}

	\begin{align*}
		\frac{dn}{dt} &= G(v, n, m) = \alpha_n(v)(1-n)-\beta_n(v)n=\\
									&=\frac{n_{\infty}(v)-n}{\tau_n(v)}
	\end{align*}

	\begin{align*}
		\frac{dm}{dt} &= H(v, n, m) = \alpha_m(v)(1-m)-\beta_m(v)m=\\
									&=\frac{m_\infty(v)-m}{\tau_m(v)}
	\end{align*}

	The number of calcium gates evolves according to this equation instead of being set to its asymptotic value $m_\infty = \frac{\alpha_m}{\alpha_m+\beta_m}$.
	The planar form of the equation is obtained by observing that $m$ approaches equilibrium faster than $n$ and $v$, so using standard arguments from singular perturbation theory this system can be brought into the planar model by replacing $F$ and $G$ with: $f(v, n) = F(v, n, m_\infty(v))$ and $g(v, n) = G(v, n, m_\infty(v))$.
	Now for the $3D$ model $\epsilon_m = \frac{v-v_a}{v_b}$ has to be introduced in addition to $\epsilon_n = \frac{v-v_c}{v_d}$.
	It can be noted how $\epsilon_x$ represents where the voltage falls along the activation curve for channel type $x$, relative to its half-activation point ($v_a$ for calcium and $v_c$ for potassium )and its slope (reciprocals of $v_b$ for calcium and $v_d$ for potassium).
	The per capita opening and closing rates for each channel type are then:

	$$\alpha_m(v) = \frac{\phi_m\cosh\frac{\epsilon_m}{2}}{1+e^{2\epsilon_m}}\quad\beta_m(v) = \frac{\phi_m\cosh\frac{\epsilon_m}{2}}{1+e^{-2\epsilon_m}}$$

	$$\alpha_n(v) = \frac{\phi_n\cosh\frac{\epsilon_n}{2}}{1+e^{2\epsilon_n}}\quad\beta_n(v) = \frac{\phi_n\cosh\frac{\epsilon_n}{2}}{1+e^{-2\epsilon_n}}$$

	With parameters:

	\begin{multicols}{3}
		\begin{itemize}
			\item $v_a = -1.2$.
			\item $v_b = 18$.
			\item $v_c = 2$.
			\item $v_d = 30$.
			\item $\phi_m = 0.4$.
			\item $\phi_n = 0.04$
		\end{itemize}
	\end{multicols}

	The asymptotic open probabilities are given by $m_\infty$ and $n_\infty$ and the time constants $\tau_m$ and $\tau_n$, which satisfy the relations:

	$$m_\infty(v) = \frac{\alpha_m(v)}{\alpha_m(v) + \beta_m(v)} = \frac{1+\tanh\epsilon_m}{2}$$

	$$n_\infty(v) = \frac{\alpha_n(v)}{\alpha_n(v) + \beta_n(v)} = \frac{1+\tanh\epsilon_n}{2}$$

	$$\tau_m(v) = \frac{1}{\phi\cosh\frac{\epsilon_m}{2}}$$

	$$\tau_n(v) = \frac{1}{\phi\cosh\frac{\epsilon_n}{2}}$$

	Assuming a population of $M_{tot}$ calcium and $N_{tot}$ potassium gates a stochastic hybrid system is obtained, with a continuous variable $V(t)$ and two discrete ones $M(t)$ and $N(t)$.
	The voltage evolves according to the sum of the applied, leak, calcium and potassium currents

	\begin{align*}
		\frac{dV}{dt} &=&  F(V(t), N(t), M(t)) = \\
									&=& \frac{1}{C}\biggl(I_{app} - g_L(V(t)-v_L)-g_{Ca}\frac{M(t)}{M_{tot}}(V(t)-v_{Ca}) +\\
									& &- g_K\frac{N(t)}{N_{tot}}(V(t)-v_K)\biggr)
	\end{align*}

	The number of open gates change only by unit increases and decreases remaining constant between such changes.
	So the channel states evolve according to:

	\begin{align*}
		M(t) =&M(0) - Y_{close}^M\biggl(\int_0^t\beta_m(V(s))M(s)ds\biggr)+\\
					&+Y_{open}^M\biggl(\int_0^t\alpha_m(V(s))(M_{tot}-M(s))ds\biggr)
	\end{align*}

	\begin{align*}
		N(t) =&N(0) - Y_{close}^N\biggl(\int_0^t\beta_n(V(s))N(s)ds\biggr)+\\
					&+Y_{open}^N\biggl(\int_0^t\alpha_n(V(s))(N_{tot}-N(s))ds\biggr)
	\end{align*}

\section{Comparison of the exact algorithm with a piecewise constant propensity approximation}
The most common implementation for hybrid ion channel models is an approximate method in which the per capita reaction propensities are held fixed between channel events: in particular in algorithm \ref{algo:random-time-change-sim}, $\int_t^{t+\Delta k}\lambda_k(V(s), X(s))ds$ is replaced with $\Delta_k\lambda_k(V(t), X(t))$, leaving the remainder unchanged.
In this type of algorithms the sequence of channel states jumps is generated using the propensity immediately following the most recent jump rather than taking into account the time dependence of the reaction propensities due to the changing voltage.
This is analogous to the forward Euler method for the numerical solution of ordinary differential equations.
The solution of a stochastic differential equation with a given initial condition is a map from the sample space $\Omega$ to a space of trajectories.
In this context $\Omega$ is one independent unit rate Poisson process per reaction channel.
For the planar model a point in $\Omega$ amounts to fixing two Poisson process, $Y_{open}$ and $Y_{closed}$ to drive the transitions of the potassium channels.
For the full 3D model there are four processes:

\begin{multicols}{2}
	\begin{itemize}
		\item $Y_1 \equiv Y_{Ca, open}$.
		\item $Y_2 \equiv Y_{Ca, closed}$.
		\item $Y_3 \equiv Y_{K, open}$.
		\item $Y_4 \equiv Y_{K, closed}$.
	\end{itemize}
\end{multicols}

The exact algorithm provides a numerical solution of the map from $\{Y_k\}_{k=1}^4\in\Omega$ and initial conditions $(M_0, N_0, V_0)$ to the trajectory $(M(t), N(t), V(t))$.
The approximate piecewise algorithm gives a map from the same domain to a different trajectory $(\tilde{M}(t), \tilde{N}(t), \tilde{V}(t)$.
To make a pathways comparison the initial condition and the four Poisson processes are fixed and the resulting trajectories are compared.
Both algorithms produce a sequence of noise-dependent voltage spike with similar firing rates.
The two trajectories remain close together initially and the timing for the first spike is similar for both.
Over time discrepancies between the trajectories accumulate: the timing of the second and third spikes is different and before ten spikes the spike trains have become uncorrelated.
Even though the trajectories diverge the two processes could still generate sample paths with similar time-dependent or stationary distributions: the two algorithms could still be close in a weak sense.
Given $M_{tot}$ and $N_{tot}$ the density for the hybrid Markov process can be written as:

$$\rho_{m,n}(v,t) = \frac{1}{dv}Pr\{M(t) = m, N(t) = n, V\in[v, v+dv]\}$$

Obeying the master equation:

\begin{align*}
	\frac{\partial\rho_{m, n}(v, t)}{\partial t} =& - \frac{\partial(F(v, n, m)\rho_{m, n}(v, t))}{\partial v} +\\
																								&-(\alpha_m(v)(M_{tot}-m)+\beta_m(v)m+\\
																								&+\alpha_n(v)\cdot(N_{tot}-m)+\beta_n(v)n)\rho_{m, n}(v, t)+\\
																								&+(M_{tot}-m+1)\alpha_m(v)\rho_{m-1, n}(v, t)+\\
																								&+(m+1)\beta_m(v)\rho_{m+1, n}(v, t)+\\
																								&+(N_{tot}-n+1)\alpha_n(v)\rho_{m, n-1}(v,t)+\\
																								&+(n+1)\beta_n(v)\rho_{m, n+1}(v, t)
\end{align*}

With initial condition $\rho_{m,n}(v,0)\ge 0$ given by any integrable density such that $\in_{v\in\mathbb{R}}\sum\limits_{m,n}\rho_{m, n}(v, 0)dv \equiv 1$ and boundary conditions:$\rho\rightarrow 0$ as $|v|\rightarrow\infty$ and $\rho\equiv 0$ for either $m, n<0$ or $m> M_{tot}$ or $n>N_{tot}$.
The approximate algorithm does not generate a Markov process since the transition probabilities depend on the past rather than the present value of the voltage.
Because of this they do not satisfy the master equation, but it is plausible that they may have a unique stationary distributoin.

Looking the histograms in the $(v, n)$ plane with entries summed over $m$.
The algorithms were run with independent randomm number streams in the limit cycle regime ($I_{app} = 100$) fir $I_{max} \approx 200000$ time units, sampled every $10$.
Considering $N_{tot} = M_{tot} = k$, for $k<5$ the difference is obvious, while increasing $k$ the histograms become more and more similar.

Looking now at bar plots of the histograms with points projected on the voltage axis: entries summed over $m$ and $n$, the plots become increasingly similar the greater the $k$>

To quantify the similarity of the histogram the empirical $L_1$ difference between them has been computed.
For the full $(v, n, m)$ histograms and then for the collapsed voltage axis.
Let $\rho_{m,n}(v)$ and $\tilde{\rho}_{m, n}(v)$ denote the stationary distributions for the exact and approximate algorithms respectively.
To compare the two the $L_1$ distance between them is approximated:

$$d(\rho,\tilde{\rho}) = \int_{v_{\min}}^{v{\max}}\biggl(\sum\limits_{m=0}^{M_{tot}}\sum\limits_{n=0}^{N_{tot}}|\rho_{m, n}(v)-\tilde{\rho}_{m,n}(v)|\biggr)dv$$

Where $v_{min}$ and $v_{max}$ where chosen so that $F(v_{min}, n, m>0\land F(v_{max}, n, m)<0\forall m,n$.
Such value must exist since $F(v,n,m)$ is linear and monotonically decreasing for $v$ for any fixed pair of $(n,m)$.
For any exact simulation algorithm, once the voltage component falls between $v_{min}\le v \le v_{max}$ it remains in that interval for all time.

\section{Coupling, variance reduction and parametric sensitivities}
The random time change formalism can be used to develop new and faster computational methods with no loss in accuracy coupling two processes in order to reduce the variance and increase the speed of different natural estimatore.
Consider for example the computation of parametric sensitivities, which is a tool that allow to determine parameters to which a system output is most responsive.
Suppose that the intensity or propensity functions are dependent on some vectors of parameters $\theta$.
$\theta$ may represent a subset of the system's mass action kinetics constants, the cell capacitance, or the underlying number of channels of each type.
To know how sensitively a quantity such as the average firing rate or interspike interval variance depends on $\theta$ a family of models $(V^\theta, X^\theta)$, parameeterized by $\theta$ is considered, with stochastic equations:

$$\frac{d}{dt}V^\theta(t) = f(\theta, V^\theta(t), X^\theta(t))$$

$$X^\theta(t) = x_0^\theta + \sum\limits_kY_k\biggl(\int_0^t\lambda_k^\theta(V^\theta(s), X^\theta(s))ds\biggr)\zeta_k$$

Where $f$ is some function and all other notation is as before.
Some quantities depend on the entire sample path.
Let $g(\theta, V^\theta, X^\theta)$ be a path functional capturing the quantity of interest.
In order to evaluate the relative shift in expectation of $g$ due to a perturbation of the parameter vector, the estimation would be:

\begin{align*}
	\tilde{s} &=\epsilon^{-1}\mathbb{E}\bigl[g(\theta', V^{\theta'}, X^{\theta'})-g(\theta, V^\theta, X^\theta)\bigr]\approx\\
						&\approx\frac{1}{\epsilon N}\sum\limits_{i=1}^N\bigl[g(\theta', V_{[i]}^{\theta'}, X_{[i]}^{\theta'})-g(\theta, V_{[i]}^\theta, X_{[i]}^\theta)\bigr]
\end{align*}

Where:

\begin{itemize}
	\item $\epsilon= ||\theta-\theta'||$.
	\item $(V_{[i]}^\theta, X_{[i]}^{\theta})$ is the $i$th path generated with parameter $\theta$.
	\item $N$ is the number of sample paths computed for the estimation.
\end{itemize}

A finite difference and Monte Carlo sampling could be used to approximate the change in expectation.
If the paths $(V_{[i]}^{\theta'}, X_{[i]}^{\theta'})$ and $(V_{[i]}^\theta, X_{[i]}^{\theta})$ are generated independently, the variance of the estimator for $\tilde{s}$ is $O(N^{-1}\epsilon^{-2})$ and its standard deviation $O(N^{-\frac{1}{2}}\epsilon^{-1})$.
In order to reduce the confidence interval of the estimator to a target level of $\rho >0$:

$$N^{-\frac{1}{2}}\epsilon^{-1}\lesssim\rho\Rightarrow N \gtrsim\epsilon^{-2}\rho^{-2}$$

Which can be prohibitive.
Reducing the variance of the estimator can be achieved coupling the processes $(V_{[i]}^{\theta'}, X_{[i]}^{\theta'})$ and $(V_{[i]}^\theta, X_{[i]}^{\theta})$ so that they are correlated by constructing them on the same probability space.
Different approach to this problem are discussed in the next sections.

	\subsection{The common random number method}
	The common random number CRN method simulates bot processes according to Gillespie representation with the same Poisson process $Y$ and the same stream of random variables $\{\epsilon_i\}$.

	\subsection{The common reaction path method}
	The common reaction path method CRP simulates both processes according to the same random time change representation with the same Poisson processes $Y_k$.
	One stream of uniform random variables for each reaction channel is created and used for the simulation of both processes.

	\subsection{The coupled finite difference method}
	The coupled finite difference method CFD utilizes a split coupling method.
	It splits the counting process for each of the reaction channels into three pieces:

	\begin{itemize}
		\item One counting process shared by $X^\theta$ and $X^{\theta'}$ and has propensity equal to the minimum of their respective intensities.
		\item One that only accounts for the jumps of $X^\theta$.
		\item One than only accounts for the jumps of $X^{\theta'}$.
	\end{itemize}

	Letting $a\land b = \min\{a, b\}$, the precise coupling is:

	\begin{align*}
		X^{\theta'}(t) = &X_0^{\theta'} + \sum\limits_kY_{k, 1}\biggl(\int_0^tm_k(\theta, \theta', s)ds\biggr)\zeta_k+\\
										 &+\sum\limits_{k}Y_{k, 2}\biggl(\int_o^t\lambda_k^{\theta'}(V^{\theta'}(s), X^{\theta'}(s))-m_k(\theta, \theta', s)ds\biggr)\zeta_k
	\end{align*}

	\begin{align*}
		X^\theta(t) = &X^\theta(t) + \sum\limits_{l}Y_{k,1}\biggl(\int_0^tm_k(\theta, \theta', s)ds\biggr)\zeta_k+\\
									&+\sum\limits_kY_{k, 3}\biggl(\int_0^t\lambda_k^0(V^\theta(s), X^\theta(s))-m_k(\theta, \theta', s)ds\biggr)\zeta_k
	\end{align*}

	Where:

	$$m_k(\theta, \theta', s) = \lambda_k^0(V^\theta(s), X^\theta(s))\land\lambda_k^{\theta'}(V^{\theta'}(s), X^{\theta'}(s))$$

	And $\{Y_{k, 1}, Y_{k, 2}, Y_{k, 3}\}$ are independent unit-rate Poisson processes.

	\subsection{Covariance and methods' performace}
	The algorithm presented could still produce statistically equivalent path.
	This is not the case for the methods for parametric sensitivities provided.
	Each of the methods constructs a coupled pair of processes $((V_{[i]}^{\theta'}, X_{[i]}^{\theta'}),(V_{[i]}^\theta, X_{[i]}^{\theta}))$  and the marginal processes $(V_{[i]}^{\theta'}, X_{[i]}^{\theta'})$ and $(V_{[i]}^\theta, X_{[i]}^{\theta})$ are all statistically equivalent no matter the method used.
	The covariance $Cov((V_{[i]}^{\theta'}, X_{[i]}^{\theta'}),(V_{[i]}^\theta, X_{[i]}^{\theta}))$  can be different.
	This is important since the objective is the variance reduction for any component $X_j$:

	$$Var(X_k^\theta(t)-X_j^{\theta'}(t)) = Var(X_j^\theta(t))+Var(X_k^{\theta'}(t))-2Cov(X_j^\theta(t), X_j^{\theta'(t)})$$

	Minimizing the variance is equivalent to maximizing the covariance.
	The CRN method is the worst at maximizing covariance.
	The CFD method with the split coupling procedure is the best, though the CRP method can be more efficient in some context.

\section{Discussion}
The random time change representation can be useful to computational neuroscience as it allows for generalization of computational methods developed in the context of biochemistry, in which the propensities depend upon the state of the jump process only, so that variance reduction strategies become feasible.
The random time change approach avoids several approximations: for example in simulation algorithms based on a fixed time step chemical Langevin approach, it is necessary to assume that the increments in channel state are Gaussian distributed over an appropriate time interval.
However in exact simulation of small patches the exact algorithm visits states incompatible with the Gaussian increment approximation regardless of time step size.
Another algorithm found in literature is the piecewise constant propensity or approximate forward algorithm.
This ignore changes to membrane potential during the intervals between channel state changes.
As the sensitivity of ion channel opening and closing to voltage is fundamental these algorithm are not appropriate unless time between openings and closing is especially small.
This study restrict attention to the suprathreshold regime of the Morris-Lecar model, in which the applied current puts the system above the Hoph bifurcation marking onset of oscillations.
Spiking is not the result of noise-facilitated release.
Another study used eigenfunction expansion methods, path integrals and theory of large deviations to study spike initiation as noise facilitated escape problem in the excitable regime, as well as to incorporate synaptic currents into a stochastic network model using versions of the exact algorithm presented in this paper.
the usual separation-of-time scales picture breaks done: the firing rate obtained by 1D Kramers rate theory when the slow recovery variable (fraction of open potassium channels) is taken to be fixed does not match that obtained by direct simulation with the exact algorithm.
By considering a maximum likelihood approach to the 2D escape problem, spontaneous closure of potassium channels contributes significantly to noise induced escape than spontaneous opening of sodium channel.
The algorithm presented are applicable beyond the effects of channel noise on the regularity of action potential firing in a single compartment neuron model.
Exact simulation of hybrid stochastic models have been used to study spontaneous dendritic NMDA spikes, intracellular growth of the T7 bacteriophage and hybrid stochastic network models taking into account piecewise deterministic synaptic currents.
The latter example represents a significant extension of the neural master equation approach to stochastic population models.
The random time change representation extends naturally to scenarios in which each channel has a greater number of states, but it would be better to combine it with complexity reduction methods such as the stochastic shielding algorithm.
Analysis of algorithms combining stochastic shielding and the random time change framework are a promising direction for future research.




% \begin{figure}[hbt!]
% \centering
% \label{volcano}
% \end{figure}
