\begin{abstract}
	In this report we present a number of models describing neuronal dynamics.
	Firstly we present a simple leaky integrate-and-fire model, a fully deterministic representation of the neuron, which equates it to a single resistance-capacitance circuit.
	The ability of generating spikes in this model is hard coded posing a threshold on the membrane potential.
	This model is then expanded as to model supra-threshold dynamics, adding to the model a new state variable, the inter-spike time, allowing to model time-dependent changes in the systems parameter.
	The deterministic model is expanded again to model spike-rate adaptation and synaptic transmission.
	The deterministic representation of the model doesn't allow to explore channels opening and closing, so we introduce a piecewise stochastic representation for the model.
	The neuron is then modelled as an hybrid system in which the voltage evolves deterministically in between stochastic channel events.
	We implemented two representation for the stochastic model: the random time change and Gillespie's direct method.
	Finally we explored how these two representation differs and propose a methodology to fit them to experimental data.
\end{abstract}
\input{chapters/01_introduction}

\input{chapters/02_random-time-representation}

\input{chapters/03_gillespie-representation}

\input{chapters/04_morris-lecar}

\input{chapters/05_more-than-one-channel-type}

\section{Comparison of the exact algorithm with a piecewise constant propensity approximation}
The most common implementation for hybrid ion channel models is an approximate method in which the per capita reaction propensities are held fixed between channel events: in particular in algorithm \ref{algo:random-time-change-sim}, $\int_t^{t+\Delta k}\lambda_k(V(s), X(s))ds$ is replaced with $\Delta_k\lambda_k(V(t), X(t))$, leaving the remainder unchanged.
In this type of algorithms the sequence of channel states jumps is generated using the propensity immediately following the most recent jump rather than taking into account the time dependence of the reaction propensities due to the changing voltage.
This is analogous to the forward Euler method for the numerical solution of ordinary differential equations.
The solution of a stochastic differential equation with a given initial condition is a map from the sample space $\Omega$ to a space of trajectories.
In this context $\Omega$ is one independent unit rate Poisson process per reaction channel.
For the planar model a point in $\Omega$ amounts to fixing two Poisson process, $Y_{open}$ and $Y_{closed}$ to drive the transitions of the potassium channels.
For the full 3D model there are four processes:

\begin{multicols}{2}
	\begin{itemize}
		\item $Y_1 \equiv Y_{Ca, open}$.
		\item $Y_2 \equiv Y_{Ca, closed}$.
		\item $Y_3 \equiv Y_{K, open}$.
		\item $Y_4 \equiv Y_{K, closed}$.
	\end{itemize}
\end{multicols}

The exact algorithm provides a numerical solution of the map from $\{Y_k\}_{k=1}^4\in\Omega$ and initial conditions $(M_0, N_0, V_0)$ to the trajectory $(M(t), N(t), V(t))$.
The approximate piecewise algorithm gives a map from the same domain to a different trajectory $(\tilde{M}(t), \tilde{N}(t), \tilde{V}(t)$.
To make a pathways comparison the initial condition and the four Poisson processes are fixed and the resulting trajectories are compared.
Both algorithms produce a sequence of noise-dependent voltage spike with similar firing rates.
The two trajectories remain close together initially and the timing for the first spike is similar for both.
Over time discrepancies between the trajectories accumulate: the timing of the second and third spikes is different and before ten spikes the spike trains have become uncorrelated.
Even though the trajectories diverge the two processes could still generate sample paths with similar time-dependent or stationary distributions: the two algorithms could still be close in a weak sense.
Given $M_{tot}$ and $N_{tot}$ the density for the hybrid Markov process can be written as:

$$\rho_{m,n}(v,t) = \frac{1}{dv}Pr\{M(t) = m, N(t) = n, V\in[v, v+dv]\}$$

Obeying the master equation:

\begin{align*}
	\frac{\partial\rho_{m, n}(v, t)}{\partial t} =& - \frac{\partial(F(v, n, m)\rho_{m, n}(v, t))}{\partial v} +\\
																								&-(\alpha_m(v)(M_{tot}-m)+\beta_m(v)m+\\
																								&+\alpha_n(v)\cdot(N_{tot}-m)+\beta_n(v)n)\rho_{m, n}(v, t)+\\
																								&+(M_{tot}-m+1)\alpha_m(v)\rho_{m-1, n}(v, t)+\\
																								&+(m+1)\beta_m(v)\rho_{m+1, n}(v, t)+\\
																								&+(N_{tot}-n+1)\alpha_n(v)\rho_{m, n-1}(v,t)+\\
																								&+(n+1)\beta_n(v)\rho_{m, n+1}(v, t)
\end{align*}

With initial condition $\rho_{m,n}(v,0)\ge 0$ given by any integrable density such that $\in_{v\in\mathbb{R}}\sum\limits_{m,n}\rho_{m, n}(v, 0)dv \equiv 1$ and boundary conditions:$\rho\rightarrow 0$ as $|v|\rightarrow\infty$ and $\rho\equiv 0$ for either $m, n<0$ or $m> M_{tot}$ or $n>N_{tot}$.
The approximate algorithm does not generate a Markov process since the transition probabilities depend on the past rather than the present value of the voltage.
Because of this they do not satisfy the master equation, but it is plausible that they may have a unique stationary distributoin.

Looking the histograms in the $(v, n)$ plane with entries summed over $m$.
The algorithms were run with independent randomm number streams in the limit cycle regime ($I_{app} = 100$) fir $I_{max} \approx 200000$ time units, sampled every $10$.
Considering $N_{tot} = M_{tot} = k$, for $k<5$ the difference is obvious, while increasing $k$ the histograms become more and more similar.

Looking now at bar plots of the histograms with points projected on the voltage axis: entries summed over $m$ and $n$, the plots become increasingly similar the greater the $k$>

To quantify the similarity of the histogram the empirical $L_1$ difference between them has been computed.
For the full $(v, n, m)$ histograms and then for the collapsed voltage axis.
Let $\rho_{m,n}(v)$ and $\tilde{\rho}_{m, n}(v)$ denote the stationary distributions for the exact and approximate algorithms respectively.
To compare the two the $L_1$ distance between them is approximated:

$$d(\rho,\tilde{\rho}) = \int_{v_{\min}}^{v{\max}}\biggl(\sum\limits_{m=0}^{M_{tot}}\sum\limits_{n=0}^{N_{tot}}|\rho_{m, n}(v)-\tilde{\rho}_{m,n}(v)|\biggr)dv$$

Where $v_{min}$ and $v_{max}$ where chosen so that $F(v_{min}, n, m>0\land F(v_{max}, n, m)<0\forall m,n$.
Such value must exist since $F(v,n,m)$ is linear and monotonically decreasing for $v$ for any fixed pair of $(n,m)$.
For any exact simulation algorithm, once the voltage component falls between $v_{min}\le v \le v_{max}$ it remains in that interval for all time.

\section{Coupling, variance reduction and parametric sensitivities}
The random time change formalism can be used to develop new and faster computational methods with no loss in accuracy coupling two processes in order to reduce the variance and increase the speed of different natural estimatore.
Consider for example the computation of parametric sensitivities, which is a tool that allow to determine parameters to which a system output is most responsive.
Suppose that the intensity or propensity functions are dependent on some vectors of parameters $\theta$.
$\theta$ may represent a subset of the system's mass action kinetics constants, the cell capacitance, or the underlying number of channels of each type.
To know how sensitively a quantity such as the average firing rate or interspike interval variance depends on $\theta$ a family of models $(V^\theta, X^\theta)$, parameeterized by $\theta$ is considered, with stochastic equations:

$$\frac{d}{dt}V^\theta(t) = f(\theta, V^\theta(t), X^\theta(t))$$

$$X^\theta(t) = x_0^\theta + \sum\limits_kY_k\biggl(\int_0^t\lambda_k^\theta(V^\theta(s), X^\theta(s))ds\biggr)\zeta_k$$

Where $f$ is some function and all other notation is as before.
Some quantities depend on the entire sample path.
Let $g(\theta, V^\theta, X^\theta)$ be a path functional capturing the quantity of interest.
In order to evaluate the relative shift in expectation of $g$ due to a perturbation of the parameter vector, the estimation would be:

\begin{align*}
	\tilde{s} &=\epsilon^{-1}\mathbb{E}\bigl[g(\theta', V^{\theta'}, X^{\theta'})-g(\theta, V^\theta, X^\theta)\bigr]\approx\\
						&\approx\frac{1}{\epsilon N}\sum\limits_{i=1}^N\bigl[g(\theta', V_{[i]}^{\theta'}, X_{[i]}^{\theta'})-g(\theta, V_{[i]}^\theta, X_{[i]}^\theta)\bigr]
\end{align*}

Where:

\begin{itemize}
	\item $\epsilon= ||\theta-\theta'||$.
	\item $(V_{[i]}^\theta, X_{[i]}^{\theta})$ is the $i$th path generated with parameter $\theta$.
	\item $N$ is the number of sample paths computed for the estimation.
\end{itemize}

A finite difference and Monte Carlo sampling could be used to approximate the change in expectation.
If the paths $(V_{[i]}^{\theta'}, X_{[i]}^{\theta'})$ and $(V_{[i]}^\theta, X_{[i]}^{\theta})$ are generated independently, the variance of the estimator for $\tilde{s}$ is $O(N^{-1}\epsilon^{-2})$ and its standard deviation $O(N^{-\frac{1}{2}}\epsilon^{-1})$.
In order to reduce the confidence interval of the estimator to a target level of $\rho >0$:

$$N^{-\frac{1}{2}}\epsilon^{-1}\lesssim\rho\Rightarrow N \gtrsim\epsilon^{-2}\rho^{-2}$$

Which can be prohibitive.
Reducing the variance of the estimator can be achieved coupling the processes $(V_{[i]}^{\theta'}, X_{[i]}^{\theta'})$ and $(V_{[i]}^\theta, X_{[i]}^{\theta})$ so that they are correlated by constructing them on the same probability space.
Different approach to this problem are discussed in the next sections.

	\subsection{The common random number method}
	The common random number CRN method simulates bot processes according to Gillespie representation with the same Poisson process $Y$ and the same stream of random variables $\{\epsilon_i\}$.

	\subsection{The common reaction path method}
	The common reaction path method CRP simulates both processes according to the same random time change representation with the same Poisson processes $Y_k$.
	One stream of uniform random variables for each reaction channel is created and used for the simulation of both processes.

	\subsection{The coupled finite difference method}
	The coupled finite difference method CFD utilizes a split coupling method.
	It splits the counting process for each of the reaction channels into three pieces:

	\begin{itemize}
		\item One counting process shared by $X^\theta$ and $X^{\theta'}$ and has propensity equal to the minimum of their respective intensities.
		\item One that only accounts for the jumps of $X^\theta$.
		\item One than only accounts for the jumps of $X^{\theta'}$.
	\end{itemize}

	Letting $a\land b = \min\{a, b\}$, the precise coupling is:

	\begin{align*}
		X^{\theta'}(t) = &X_0^{\theta'} + \sum\limits_kY_{k, 1}\biggl(\int_0^tm_k(\theta, \theta', s)ds\biggr)\zeta_k+\\
										 &+\sum\limits_{k}Y_{k, 2}\biggl(\int_o^t\lambda_k^{\theta'}(V^{\theta'}(s), X^{\theta'}(s))-m_k(\theta, \theta', s)ds\biggr)\zeta_k
	\end{align*}

	\begin{align*}
		X^\theta(t) = &X^\theta(t) + \sum\limits_{l}Y_{k,1}\biggl(\int_0^tm_k(\theta, \theta', s)ds\biggr)\zeta_k+\\
									&+\sum\limits_kY_{k, 3}\biggl(\int_0^t\lambda_k^0(V^\theta(s), X^\theta(s))-m_k(\theta, \theta', s)ds\biggr)\zeta_k
	\end{align*}

	Where:

	$$m_k(\theta, \theta', s) = \lambda_k^0(V^\theta(s), X^\theta(s))\land\lambda_k^{\theta'}(V^{\theta'}(s), X^{\theta'}(s))$$

	And $\{Y_{k, 1}, Y_{k, 2}, Y_{k, 3}\}$ are independent unit-rate Poisson processes.

	\subsection{Covariance and methods' performace}
	The algorithm presented could still produce statistically equivalent path.
	This is not the case for the methods for parametric sensitivities provided.
	Each of the methods constructs a coupled pair of processes $((V_{[i]}^{\theta'}, X_{[i]}^{\theta'}),(V_{[i]}^\theta, X_{[i]}^{\theta}))$  and the marginal processes $(V_{[i]}^{\theta'}, X_{[i]}^{\theta'})$ and $(V_{[i]}^\theta, X_{[i]}^{\theta})$ are all statistically equivalent no matter the method used.
	The covariance $Cov((V_{[i]}^{\theta'}, X_{[i]}^{\theta'}),(V_{[i]}^\theta, X_{[i]}^{\theta}))$  can be different.
	This is important since the objective is the variance reduction for any component $X_j$:

	$$Var(X_k^\theta(t)-X_j^{\theta'}(t)) = Var(X_j^\theta(t))+Var(X_k^{\theta'}(t))-2Cov(X_j^\theta(t), X_j^{\theta'(t)})$$

	Minimizing the variance is equivalent to maximizing the covariance.
	The CRN method is the worst at maximizing covariance.
	The CFD method with the split coupling procedure is the best, though the CRP method can be more efficient in some context.

\section{Discussion}
The random time change representation can be useful to computational neuroscience as it allows for generalization of computational methods developed in the context of biochemistry, in which the propensities depend upon the state of the jump process only, so that variance reduction strategies become feasible.
The random time change approach avoids several approximations: for example in simulation algorithms based on a fixed time step chemical Langevin approach, it is necessary to assume that the increments in channel state are Gaussian distributed over an appropriate time interval.
However in exact simulation of small patches the exact algorithm visits states incompatible with the Gaussian increment approximation regardless of time step size.
Another algorithm found in literature is the piecewise constant propensity or approximate forward algorithm.
This ignore changes to membrane potential during the intervals between channel state changes.
As the sensitivity of ion channel opening and closing to voltage is fundamental these algorithm are not appropriate unless time between openings and closing is especially small.
This study restrict attention to the suprathreshold regime of the Morris-Lecar model, in which the applied current puts the system above the Hoph bifurcation marking onset of oscillations.
Spiking is not the result of noise-facilitated release.
Another study used eigenfunction expansion methods, path integrals and theory of large deviations to study spike initiation as noise facilitated escape problem in the excitable regime, as well as to incorporate synaptic currents into a stochastic network model using versions of the exact algorithm presented in this paper.
the usual separation-of-time scales picture breaks done: the firing rate obtained by 1D Kramers rate theory when the slow recovery variable (fraction of open potassium channels) is taken to be fixed does not match that obtained by direct simulation with the exact algorithm.
By considering a maximum likelihood approach to the 2D escape problem, spontaneous closure of potassium channels contributes significantly to noise induced escape than spontaneous opening of sodium channel.
The algorithm presented are applicable beyond the effects of channel noise on the regularity of action potential firing in a single compartment neuron model.
Exact simulation of hybrid stochastic models have been used to study spontaneous dendritic NMDA spikes, intracellular growth of the T7 bacteriophage and hybrid stochastic network models taking into account piecewise deterministic synaptic currents.
The latter example represents a significant extension of the neural master equation approach to stochastic population models.
The random time change representation extends naturally to scenarios in which each channel has a greater number of states, but it would be better to combine it with complexity reduction methods such as the stochastic shielding algorithm.
Analysis of algorithms combining stochastic shielding and the random time change framework are a promising direction for future research.




% \begin{figure}[hbt!]
% \centering
% \label{volcano}
% \end{figure}
